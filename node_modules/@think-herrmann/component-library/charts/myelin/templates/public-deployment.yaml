---
apiVersion: extensions/v1beta1
kind: Deployment

metadata:
  name: {{ .Chart.Name }}-public

spec:
  template:
    metadata:
      labels:
        app: {{ .Chart.Name }}-public
        env: {{ .Values.env }}
    spec:
      containers:
        - name: {{ .Chart.Name }}-public-nginx
          image: {{ .Values.image.org }}/{{ .Values.image.nginx.name }}:sandbox
          ports:
            - containerPort: 80
          env:
            - name: COMMIT
              value: {{ .Values.commit | quote }}
            - name: SIDECAR_ENABLE
              value: "true"
            - name: SECRET_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.env }}-app-env
                  key: SECRET_KEY_BASE
            - name: ANALYTICS_ENABLED
              value: "true"
            - name: GA_ID
              valueFrom:
                configMapKeyRef:
                  name: {{ .Values.env }}-app-env
                  key: GA_ID
          imagePullPolicy: {{ .Values.image.pullPolicy }}
        - name: {{ .Chart.Name }}-public
          image: {{ .Values.image.org }}/{{ .Values.image.app.name }}:tech
          ports:
            - containerPort: 3000
          env:
            - name: COMMIT
              value: {{ .Values.commit | quote }}
            - name: TARGET
              value: public
          imagePullPolicy: {{ .Values.image.pullPolicy }}
