FROM node:10-alpine

RUN apk update && apk upgrade && \
    apk add --no-cache git openssh alpine-sdk python

RUN addgroup -S app && adduser -S -G app app
USER app

WORKDIR /home/app

ADD --chown=app:app deploy_key_rsa /home/app/.ssh/id_rsa
ADD --chown=app:app known_hosts /home/app/.ssh/known_hosts
ADD --chown=app:app package.json /home/app
ADD --chown=app:app yarn.lock /home/app
RUN chmod 600 /home/app/.ssh/*

RUN yarn install --frozen-lockfile --production=false

ADD . /home/app

RUN yarn run build-storybook -c .storybook/public -o public
RUN yarn run build-storybook -c .storybook/internal -o internal

RUN cp serve.public.json public/serve.json
RUN cp serve.internal.json internal/serve.json

CMD yarn run serve -p 3000 $TARGET
